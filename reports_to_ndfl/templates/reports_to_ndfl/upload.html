<!DOCTYPE html>
<html>
<head>
    <title>–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—á–µ—Ç–æ–≤ –±—Ä–æ–∫–µ—Ä–∞</title>
    <style>
        body { font-family: sans-serif; margin: 20px; line-height: 1.6; background-color: #f4f7f6; }
        h1, h2, h3, h4, h5 { color: #333; }
        .container { display: flex; flex-wrap: wrap; gap: 20px; }
        .main-content { flex: 2; min-width: 200px;}
        .sidebar { flex: 3; min-width: 300px; }

        .messages { list-style-type: none; padding: 0; margin-bottom: 20px; }
        .messages li { margin-bottom: 10px; padding: 10px 15px; border-radius: 4px; border: 1px solid transparent; }
        .messages li.success { background-color: #d4edda; color: #155724; border-color: #c3e6cb; }
        .messages li.error { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb; }
        .messages li.warning { background-color: #fff3cd; color: #856404; border-color: #ffeeba; }
        .messages li.info { background-color: #d1ecf1; color: #0c5460; border-color: #bee5eb; }

        .form-section {
            border: 1px solid #ddd;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 5px;
            background-color: #ffffff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .form-section h3 { margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px; }

        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555}
        input[type="number"], input[type="file"], select {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: calc(100% - 22px);
            box-sizing: border-box;
            margin-bottom: 10px;
        }
        button[type="submit"] {
            padding: 12px 25px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease;
        }
        button[type="submit"]:hover { background-color: #0056b3; }
        .secondary-button {
            background-color: #6c757d;
        }
        .secondary-button:hover {
            background-color: #5a6268;
        }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9em; table-layout: auto; background-color: #fff; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; word-wrap: break-word; }
        th { background-color: #e9ecef; font-weight: bold; white-space: nowrap; color: #495057; }
        td.numeric { text-align: right; }

        .content-block {
            margin-bottom: 30px;
            border: 1px solid #ccc;
            padding: 20px;
            border-radius: 5px;
            background-color: #ffffff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            overflow-x: auto;
        }
        .content-block h3 {
             border-bottom: 1px solid #eee; padding-bottom: 10px; margin-top:0;
        }
        .content-block h2 {
            margin-top:0;
        }
        .conversion-row td { background-color: #e6f7ff !important; font-style: italic;}
        .aggregated-trade-row td {}
        .non-relevant-row td { color: #999; }
        .option-delivery-row { border-left: 4px solid #ffc107; }
        .option-info-row td { background-color: #f0f8ff !important; font-size: 0.95em; }
        .option-info-row.non-relevant-row td { color: #999; }

        /* –¶–≤–µ—Ç–Ω—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Å–≤—è–∑–µ–π */
        .quantity-cell {
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
        }

        .link-indicators {
            display: flex;
            gap: 4px;
            flex-shrink: 0;
        }

        .link-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 2px;
            vertical-align: middle;
            border: 1px solid rgba(0,0,0,0.2);
        }

        .quantity-value {
            text-align: right;
            flex-grow: 1;
            margin-left: 8px;
        }


        #selected_files ul { list-style-type: disc; margin-left: 20px; padding-left: 0; margin-top: 5px; }
        #selected_files h4 { margin-bottom: 5px; }

        .user-info { text-align: right; margin-bottom: 20px; padding-bottom:10px; border-bottom: 1px solid #eee; }
        .user-info a { color: #007bff; text-decoration: none; }
        .user-info a:hover { text-decoration: underline; }

        .previously-uploaded-section {
            padding:20px;
            border: 1px solid #e0e0e0;
            background-color:#f0f0f0;
            border-radius:5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .previously-uploaded-section h4 { margin-top: 0; border-bottom: 1px solid #ddd; padding-bottom: 10px;}
        .previously-uploaded-section ul { list-style-type: none; padding-left: 0; }
        .previously-uploaded-section li {
            background-color: #fff;
            border: 1px solid #eee;
            padding: 10px 15px;
            margin-bottom: 8px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.95em;
        }
        .file-info {
            display: flex;
            align-items: center;
            flex-grow: 1;
        }
        .delete-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.85em;
            transition: background-color 0.3s ease;
            margin-left: 10px;
        }
        .delete-btn:hover {
            background-color: #c82333;
        }
        .previously-uploaded-section li .date { font-size: 0.85em; color: #777; margin-left: 10px; white-space: nowrap;}

        .no-data-message { margin-top: 20px; padding: 15px; background-color: #f8f9fa; border: 1px solid #ced4da; border-radius: 4px; text-align: center; color: #495057;}

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤—ã–±–æ—Ä–∞ –≥–æ–¥–∞ */
        .year-selector {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .year-btn {
            padding: 10px 20px;
            border: 2px solid #007bff;
            background-color: #fff;
            color: #007bff;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.2s ease;
        }

        .year-btn:hover {
            background-color: #e6f0ff;
        }

        .year-btn.selected {
            background-color: #007bff;
            color: white;
        }

        .no-years-message {
            color: #666;
            font-style: italic;
            margin-bottom: 15px;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏ */
        button[type="submit"]:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            opacity: 0.6;
        }

        button[type="submit"]:disabled:hover {
            background-color: #cccccc;
        }

        @media (max-width: 768px) {
            .container { flex-direction: column; }
            .main-content, .sidebar { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="user-info">
        {% if user.is_authenticated %}
            –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <strong>{{ user.username }}</strong> | <a href="{% url 'logout' %}">–í—ã–π—Ç–∏</a>
        {% else %}
            <a href="{% url 'login' %}">–í–æ–π—Ç–∏</a>
        {% endif %}
    </div>

    <h1>–ó–∞–≥—Ä—É–∑–∫–∞ –∏ –∞–Ω–∞–ª–∏–∑ –æ—Ç—á–µ—Ç–æ–≤ –±—Ä–æ–∫–µ—Ä–∞</h1>

    {% if messages %}
        <ul class="messages">
            {% for message in messages %}
                <li class="{{ message.tags }}">{{ message }}</li>
            {% endfor %}
        </ul>
    {% endif %}

    <div class="container">
        <div class="main-content">
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="form-section">
                    <h3>1. –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—á–µ—Ç–æ–≤ –±—Ä–æ–∫–µ—Ä–∞</h3>
                    <div>
                        <label for="broker_type_select">–ë—Ä–æ–∫–µ—Ä:</label>
                        <select name="broker_type" id="broker_type_select">
                            <option value="ffg" {% if selected_broker_type == 'ffg' %}selected{% endif %}>Freedom Finance Global (.xml)</option>
                            <option value="ib" {% if selected_broker_type == 'ib' %}selected{% endif %}>Interactive Brokers (.csv)</option>
                        </select>
                    </div>
                    <div>
                        <label for="report_file_input">–§–∞–π–ª(—ã) –æ—Ç—á–µ—Ç–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏:</label>
                        <input type="file" name="report_file" id="report_file_input" multiple accept=".xml">
                        <small id="file_format_hint" style="color: #666;">–§–æ—Ä–º–∞—Ç: .xml</small>
                    </div>
                    <div id="selected_files" style="margin-top:10px; margin-bottom:15px;"></div>
                    <button type="submit" name="action" value="upload_reports">–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –æ—Ç—á–µ—Ç—ã</button>
                </div>
                <div class="form-section">
                    <h3>2. –ê–Ω–∞–ª–∏–∑ –∏ —Ä–∞—Å—á–µ—Ç —Å–¥–µ–ª–æ–∫ –∏ –¥–∏–≤–∏–¥–µ–Ω–¥–æ–≤</h3>
                    <div>
                        <label>–¶–µ–ª–µ–≤–æ–π –≥–æ–¥ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞:</label>
                        {% if available_years %}
                            <div class="year-selector" id="year_selector">
                                {% for year in available_years %}
                                    <button type="button"
                                            class="year-btn {% if year == selected_year %}selected{% endif %}"
                                            data-year="{{ year }}"
                                            onclick="selectYear({{ year }}, this)">
                                        {{ year }}
                                    </button>
                                {% endfor %}
                            </div>
                            <input type="hidden" name="year_for_process" id="year_input_process" value="{{ selected_year|default:'' }}">
                        {% else %}
                            <p class="no-years-message">–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –æ—Ç—á—ë—Ç—ã –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –±—Ä–æ–∫–µ—Ä–∞</p>
                            <input type="hidden" name="year_for_process" id="year_input_process" value="">
                        {% endif %}
                    </div>
                    <button type="submit" name="action" value="process_trades" id="process_btn" disabled>–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∑–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –≥–æ–¥</button>
                </div>
            </form>
        </div>
        <div class="sidebar">
            {% if user.is_authenticated %}
            <div class="previously-uploaded-section">
                <h4>–†–∞–Ω–µ–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –≤–∞–º–∏ –æ—Ç—á–µ—Ç—ã:</h4>
                <form method="post" style="margin: 0 0 10px 0;" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –æ—Ç—á–µ—Ç—ã?');">
                    {% csrf_token %}
                    <button type="submit" name="action" value="delete_all_reports" class="secondary-button">–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –æ—Ç—á–µ—Ç—ã</button>
                </form>
                {% if previously_uploaded_files %}
                    <ul>
                        {% for file_entry in previously_uploaded_files %}
                        <li>
                            <div class="file-info">
                                <span>{{ file_entry.original_filename }} ({{ file_entry.get_broker_type_display }} ‚Äî {{ file_entry.year }} –≥–æ–¥)</span>
                                <span class="date">–ó–∞–≥—Ä—É–∂–µ–Ω: {{ file_entry.uploaded_at|date:"d.m.Y H:i" }}</span>
                            </div>
                            <form method="post" action="{% url 'delete_xml_file' file_entry.id %}" style="margin: 0;" onsubmit="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª {{ file_entry.original_filename }}?');">
                                {% csrf_token %}
                                <button type="submit" class="delete-btn">–£–¥–∞–ª–∏—Ç—å</button>
                            </form>
                        </li>
                        {% endfor %}
                    </ul>
                {% else %} <p>–í—ã –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–∞–ª–∏ –æ—Ç—á–µ—Ç—ã.</p> {% endif %}
            </div>
            {% endif %}
        </div>
    </div>

    {% if instrument_history_1530 %}
        <div class="content-block">
            <h2>–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π —Å —Ü–µ–Ω–Ω—ã–º–∏ –±—É–º–∞–≥–∞–º–∏ –∑–∞ {{ target_report_year_for_title|default:"—É–∫–∞–∑–∞–Ω–Ω—ã–π" }} –≥–æ–¥ (–∫–æ–¥ –¥–æ—Ö–æ–¥–∞ 1530):
                <p><small>–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: {{ profit_by_income_code.1530|floatformat:2|default:"0.00" }} RUB</small></p>
            </h2>
            <p style="font-size: 0.9em; color: #666; margin-top: 5px;"><em>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: —Å–µ—Ä—ã–º —Ü–≤–µ—Ç–æ–º –≤—ã–¥–µ–ª–µ–Ω—ã –æ–ø–µ—Ä–∞—Ü–∏–∏, –Ω–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –ø—Ä–æ–¥–∞–∂–∞–º–∏ –≤ {{ target_report_year_for_title }} –≥–æ–¥—É</em></p>
            <br>
            {% for grouping_isin, event_list in instrument_history_1530.items %}
                <div class="instrument-specific-block" style="margin-bottom: 20px;">
                    {% with first_event_wrapper=event_list.0 %}{% with first_event=first_event_wrapper.event_details %}
                        {% if first_event_wrapper.display_type == 'conversion_info' %}
                            <h3>–ê–∫—Ü–∏–∏: {{ first_event.old_instr_nm|default:first_event.old_ticker }} ({{ first_event.old_isin }}) / {{ first_event.old_ticker }}<br>
                            –ê–∫—Ü–∏–∏: {{ first_event.new_instr_nm|default:first_event.new_ticker }} ({{ first_event.new_isin }}) / {{ first_event.new_ticker }}</h3>
                        {% elif first_event_wrapper.display_type == 'option' %}
                            <h3>–û–ø—Ü–∏–æ–Ω: {{ first_event.instr_nm|default_if_none:"[–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –Ω–µ —É–∫–∞–∑–∞–Ω–æ]" }}</h3>
                        {% elif first_event_wrapper.display_type == 'trade' or first_event_wrapper.display_type == 'initial_holding' %}
                            <h3>{% if first_event.instr_kind %}{{ first_event.instr_kind|title }}{% else %}–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç{% endif %}: {% if first_event.ticker or first_event.symbol %}{{ first_event.ticker|default:first_event.symbol }}{% if first_event.instr_nm %} - {{ first_event.instr_nm }}{% endif %}{% else %}{{ first_event.instr_nm|default_if_none:grouping_isin }}{% endif %}{% if first_event.isin and first_event.isin != grouping_isin %} ({{ first_event.isin }}){% endif %}</h3>
                        {% else %}<h3>–ò—Å—Ç–æ—Ä–∏—è –¥–ª—è ISIN: {{ grouping_isin }}</h3>{% endif %}
                    {% endwith %}{% endwith %}
                    <table>
                        <thead><tr><th>–î–∞—Ç–∞</th><!-- <th>ID</th> --><th>–û–ø–µ—Ä–∞—Ü–∏—è</th><th>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç</th><th class="numeric">–¶–µ–Ω–∞</th><th class="numeric">–ö–æ–ª-–≤–æ</th><th class="numeric">–°—É–º–º–∞</th><th class="numeric">–ö–æ–º–∏—Å—Å–∏—è</th><th class="numeric">–ò—Ç–æ–≥–æ –∑–∞—Ç—Ä–∞—Ç, –†—É–±</th></tr></thead>
                        <tbody>
                            {% for event_wrapper in event_list %}{% with event=event_wrapper.event_details %}
                                {% if event_wrapper.display_type == 'trade' %}
                                    <tr class="{% if event.is_aggregated %}aggregated-trade-row{% endif %}{% if not event.is_relevant_for_target_year %} non-relevant-row{% endif %}{% if event.is_option_delivery %} option-delivery-row{% endif %}">
                                        <td>{{ event.date|default:"-" }} {% if event.is_aggregated %}<small>(Aggregated)</small>{% endif %}{% if event.is_option_delivery %}<br><span style="background: #fff3cd; padding: 2px 6px; border-radius: 3px; font-size: 0.85em;">üìã –ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–ø—Ü–∏–æ–Ω–∞</span>{% endif %}</td>
                                        <!-- <td> {{ event.trade_id|default:"-" }}</td> -->
                                        <td>{% if event.operation|lower == 'buy' %}–ü–æ–∫—É–ø–∫–∞{% elif event.operation|lower == 'sell' %}–ü—Ä–æ–¥–∞–∂–∞{% else %}{{ event.operation|default:"-" }}{% endif %}</td>
                                        <td>{{ event.ticker|default:event.symbol|default:event.isin }}</td>
                                        <td class="numeric">{{ event.p|default:"-" }}<small> {{ event.curr_c|default:"" }}</small></td>
                                        <td class="quantity-cell">
                                            <span class="link-indicators">
                                                {% if event.link_colors and event.is_relevant_for_target_year %}
                                                    {% for color in event.link_colors %}
                                                        <span class="link-indicator" style="background-color: {{ color }};"></span>
                                                    {% endfor %}
                                                {% endif %}
                                            </span>
                                            <span class="quantity-value">{{ event.q|default:"-" }}</span>
                                        </td>
                                        <td class="numeric"><strong>{{ event.summ|default:"-" }}</strong><small> {{ event.curr_c|default:"" }}</small></td>
                                        <td class="numeric">{{ event.commission|default:"-" }}<small> {{ event.curr_c|default:"" }}</small></td>
                                        <td class="numeric"><strong>{{ event.fifo_cost_rub_str|default:"-" }}</strong></td>
                                    </tr>
                                {% elif event_wrapper.display_type == 'conversion_info' %}
                                    <tr class="conversion-row{% if not event.is_relevant_for_target_year %} non-relevant-row{% endif %}">
                                        <td>{{ event_wrapper.datetime_obj|date:"Y-m-d" }}</td>
                                        <td colspan="7"><strong>–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è:</strong> {{ event.old_quantity_removed|default:'?' }} {{ event.old_ticker }} ‚Üí {{ event.new_quantity_received|default:'?' }} {{ event.new_ticker }}</td>
                                    </tr>
                                {% elif event_wrapper.display_type == 'initial_holding' %}
                                    <tr class="{% if not event.is_relevant_for_target_year %}non-relevant-row{% endif %}">
                                        <td>{{ event_wrapper.datetime_obj|date:"Y-m-d H:i:s" }}</td><!-- <td>–ù–∞—á–∞–ª—å–Ω—ã–π –æ—Å—Ç–∞—Ç–æ–∫</td> --><td>–ó–∞—á–∏—Å–ª–µ–Ω–∏–µ</td>
                                        <td>{{ event.ticker|default:event.symbol|default:event.isin }}</td>
                                        <td class="numeric">{{ event.p|default:"-" }} <small>{{ event.curr_c|default:"" }}</small></td>
                                        <td class="numeric">{{ event.q|default:"-" }}</td>
                                        <td class="numeric">–û–±—â. —Å—Ç–æ–∏–º. {{ event.total_cost_rub_str|default:"-" }} RUB</td>
                                        <td>-</td><td>-</td>
                                    </tr>
                                {% elif event_wrapper.display_type == 'option' %}
                                    <tr style="border-left: 4px solid #ff9800;">
                                        <td>{{ event.date|default:"-" }}</td>
                                        <!-- <td>{{ event.trade_id|default:"-" }}</td> -->
                                        <td><strong>–ü–æ–∫—É–ø–∫–∞ –æ–ø—Ü–∏–æ–Ω–∞</strong></td>
                                        <td><strong>{{ event.ticker|default:event.symbol|default:"-" }}</strong></td>
                                        <td class="numeric">{{ event.p|default:"-" }}</td>
                                        <td class="quantity-cell">
                                            <span class="link-indicators">
                                                {% if event.link_colors %}
                                                    {% for color in event.link_colors %}
                                                        <span class="link-indicator" style="background-color: {{ color }};"></span>
                                                    {% endfor %}
                                                {% endif %}
                                            </span>
                                            <span class="quantity-value">{{ event.q|default:"-" }}</span>
                                        </td>
                                        <td class="numeric"><strong>{{ event.summ|default:"-" }}</strong><small> {{ event.curr_c|default:"" }}</small></td>
                                        <td class="numeric">{{ event.commission|default:"-" }}<small> {{ event.curr_c|default:"" }}</small></td>
                                        <td style="font-style: italic; color: #666;">–£—á—Ç–µ–Ω–æ –≤ –ø–æ—Å—Ç–∞–≤–∫–µ</td>
                                    </tr>
                                {% endif %}
                            {% endwith %}{% endfor %}
                        </tbody>
                    </table>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    {% if instrument_history_1532 %}
        <div class="content-block">
            <h2>–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π –ø–æ –ø—Ä–æ–∏–∑–≤–æ–¥–Ω—ã–º —Ñ–∏–Ω. –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º –∑–∞ {{ target_report_year_for_title|default:"—É–∫–∞–∑–∞–Ω–Ω—ã–π" }} –≥–æ–¥ (–∫–æ–¥ –¥–æ—Ö–æ–¥–∞ 1532):
                <p><small>–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: {{ profit_by_income_code.1532|floatformat:2|default:"0.00" }} RUB</small></p>
            </h2>
            <p style="font-size: 0.9em; color: #666; margin-top: 5px;"><em>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: —Å–µ—Ä—ã–º —Ü–≤–µ—Ç–æ–º –≤—ã–¥–µ–ª–µ–Ω—ã –æ–ø–µ—Ä–∞—Ü–∏–∏, –Ω–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –ø—Ä–æ–¥–∞–∂–∞–º–∏ –≤ {{ target_report_year_for_title }} –≥–æ–¥—É</em></p>
            <br>
            {% for grouping_isin, event_list in instrument_history_1532.items %}
                <div class="instrument-specific-block" style="margin-bottom: 20px;">
                    {% with first_event_wrapper=event_list.0 %}{% with first_event=first_event_wrapper.event_details %}
                        {% if first_event_wrapper.display_type == 'conversion_info' %}
                            <h3>–ê–∫—Ü–∏–∏: {{ first_event.old_instr_nm|default:first_event.old_ticker }} ({{ first_event.old_isin }}) / {{ first_event.old_ticker }}<br>
                            –ê–∫—Ü–∏–∏: {{ first_event.new_instr_nm|default:first_event.new_ticker }} ({{ first_event.new_isin }}) / {{ first_event.new_ticker }}</h3>
                        {% elif first_event_wrapper.display_type == 'option' %}
                            <h3>–û–ø—Ü–∏–æ–Ω: {{ first_event.instr_nm|default_if_none:"[–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –Ω–µ —É–∫–∞–∑–∞–Ω–æ]" }}</h3>
                        {% elif first_event_wrapper.display_type == 'trade' or first_event_wrapper.display_type == 'initial_holding' %}
                            <h3>{% if first_event.instr_kind %}{{ first_event.instr_kind|title }}{% else %}–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç{% endif %}: {% if first_event.ticker or first_event.symbol %}{{ first_event.ticker|default:first_event.symbol }}{% if first_event.instr_nm %} - {{ first_event.instr_nm }}{% endif %}{% else %}{{ first_event.instr_nm|default_if_none:grouping_isin }}{% endif %}{% if first_event.isin and first_event.isin != grouping_isin %} ({{ first_event.isin }}){% endif %}</h3>
                        {% else %}<h3>–ò—Å—Ç–æ—Ä–∏—è –¥–ª—è ISIN: {{ grouping_isin }}</h3>{% endif %}
                    {% endwith %}{% endwith %}
                    <table>
                        <thead><tr><th>–î–∞—Ç–∞</th><!-- <th>ID</th> --><th>–û–ø–µ—Ä–∞—Ü–∏—è</th><th>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç</th><th class="numeric">–¶–µ–Ω–∞</th><th class="numeric">–ö–æ–ª-–≤–æ</th><th class="numeric">–°—É–º–º–∞</th><th class="numeric">–ö–æ–º–∏—Å—Å–∏—è</th><th class="numeric">–ò—Ç–æ–≥–æ –∑–∞—Ç—Ä–∞—Ç, –†—É–±</th></tr></thead>
                        <tbody>
                            {% for event_wrapper in event_list %}{% with event=event_wrapper.event_details %}
                                {% if event_wrapper.display_type == 'trade' %}
                                    <tr class="{% if event.is_aggregated %}aggregated-trade-row{% endif %}{% if not event.is_relevant_for_target_year %} non-relevant-row{% endif %}{% if event.is_option_delivery %} option-delivery-row{% endif %}">
                                        <td>{{ event.date|default:"-" }} {% if event.is_aggregated %}<small>(Aggregated)</small>{% endif %}{% if event.is_option_delivery %}<br><span style="background: #fff3cd; padding: 2px 6px; border-radius: 3px; font-size: 0.85em;">–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–ø—Ü–∏–æ–Ω–∞</span>{% endif %}</td>
                                        <!-- <td> {{ event.trade_id|default:"-" }}</td> -->
                                        <td>{% if event.operation|lower == 'buy' %}–ü–æ–∫—É–ø–∫–∞{% elif event.operation|lower == 'sell' %}–ü—Ä–æ–¥–∞–∂–∞{% else %}{{ event.operation|default:"-" }}{% endif %}</td>
                                        <td>{{ event.ticker|default:event.symbol|default:event.isin }}</td>
                                        <td class="numeric">{{ event.p|default:"-" }}<small> {{ event.curr_c|default:"" }}</small></td>
                                        <td class="quantity-cell">
                                            <span class="link-indicators">
                                                {% if event.link_colors and event.is_relevant_for_target_year %}
                                                    {% for color in event.link_colors %}
                                                        <span class="link-indicator" style="background-color: {{ color }};"></span>
                                                    {% endfor %}
                                                {% endif %}
                                            </span>
                                            <span class="quantity-value">{{ event.q|default:"-" }}</span>
                                        </td>
                                        <td class="numeric"><strong>{{ event.summ|default:"-" }}</strong><small> {{ event.curr_c|default:"" }}</small></td>
                                        <td class="numeric">{{ event.commission|default:"-" }}<small> {{ event.curr_c|default:"" }}</small></td>
                                        <td class="numeric"><strong>{{ event.fifo_cost_rub_str|default:"-" }}</strong></td>
                                    </tr>
                                {% elif event_wrapper.display_type == 'conversion_info' %}
                                    <tr class="conversion-row{% if not event.is_relevant_for_target_year %} non-relevant-row{% endif %}">
                                        <td>{{ event_wrapper.datetime_obj|date:"Y-m-d" }}</td>
                                        <td colspan="7"><strong>–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è:</strong> {{ event.old_quantity_removed|default:'?' }} {{ event.old_ticker }} ‚Üí {{ event.new_quantity_received|default:'?' }} {{ event.new_ticker }}</td>
                                    </tr>
                                {% elif event_wrapper.display_type == 'initial_holding' %}
                                    <tr class="{% if not event.is_relevant_for_target_year %}non-relevant-row{% endif %}">
                                        <td>{{ event_wrapper.datetime_obj|date:"Y-m-d H:i:s" }}</td><!-- <td>–ù–∞—á–∞–ª—å–Ω—ã–π –æ—Å—Ç–∞—Ç–æ–∫</td> --><td>–ó–∞—á–∏—Å–ª–µ–Ω–∏–µ</td>
                                        <td>{{ event.ticker|default:event.symbol|default:event.isin }}</td>
                                        <td class="numeric">{{ event.p|default:"-" }} <small>{{ event.curr_c|default:"" }}</small></td>
                                        <td class="numeric">{{ event.q|default:"-" }}</td>
                                        <td class="numeric">–û–±—â. —Å—Ç–æ–∏–º. {{ event.total_cost_rub_str|default:"-" }} RUB</td>
                                        <td>-</td><td>-</td>
                                    </tr>
                                {% elif event_wrapper.display_type == 'option' %}
                                    <tr style="border-left: 4px solid #ff9800;">
                                        <td>{{ event.date|default:"-" }}</td>
                                        <!-- <td>{{ event.trade_id|default:"-" }}</td> -->
                                        <td><strong>–ü–æ–∫—É–ø–∫–∞ –æ–ø—Ü–∏–æ–Ω–∞</strong></td>
                                        <td><strong>{{ event.ticker|default:event.symbol|default:"-" }}</strong></td>
                                        <td class="numeric">{{ event.p|default:"-" }}</td>
                                        <td class="quantity-cell">
                                            <span class="link-indicators">
                                                {% if event.link_colors %}
                                                    {% for color in event.link_colors %}
                                                        <span class="link-indicator" style="background-color: {{ color }};"></span>
                                                    {% endfor %}
                                                {% endif %}
                                            </span>
                                            <span class="quantity-value">{{ event.q|default:"-" }}</span>
                                        </td>
                                        <td class="numeric"><strong>{{ event.summ|default:"-" }}</strong><small> {{ event.curr_c|default:"" }}</small></td>
                                        <td class="numeric">{{ event.commission|default:"-" }}<small> {{ event.curr_c|default:"" }}</small></td>
                                        <td style="font-style: italic; color: #666;">–£—á—Ç–µ–Ω–æ –≤ –ø–æ—Å—Ç–∞–≤–∫–µ</td>
                                    </tr>
                                {% endif %}
                            {% endwith %}{% endfor %}
                        </tbody>
                    </table>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    {% if dividend_history %}
        <div class="content-block">
            <h2>–ò—Å—Ç–æ—Ä–∏—è –¥–∏–≤–∏–¥–µ–Ω–¥–æ–≤ –∑–∞ {{ target_report_year_for_title|default:"—É–∫–∞–∑–∞–Ω–Ω—ã–π" }} –≥–æ–¥ (–∫–æ–¥ –¥–æ—Ö–æ–¥–∞ 1010):
                {% if total_dividends_rub > 0 %}
                 <p><small>–û–±—â–∞—è —Å—É–º–º–∞ –¥–∏–≤–∏–¥–µ–Ω–¥–æ–≤ –¥–æ –Ω–∞–ª–æ–≥–æ–≤: {{ total_dividends_rub|floatformat:2 }} RUB</p></small> {% endif %}
                 <br>
            </h2>
            <table>
                <thead>
                    <tr>
                        <th>–î–∞—Ç–∞ –≤—ã–ø–ª–∞—Ç—ã</th>
                        <th>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç</th>
                        <th class="numeric">–°—É–º–º–∞ –¥–∏–≤–∏–¥–µ–Ω–¥–∞</th>
                        <th class="numeric">–£–¥–µ—Ä–∂–∞–Ω–Ω—ã–π –Ω–∞–ª–æ–≥</th>
                        <th>–í–∞–ª—é—Ç–∞</th>
                        <th class="numeric">–ö—É—Ä—Å –¶–ë –Ω–∞ –¥–∞—Ç—É</th>
                    </tr>
                </thead>
                <tbody>
                    {% for div_event in dividend_history %}
                        <tr>
                            <td>{{ div_event.date|date:"Y-m-d" }}</td>
                            <td>{{ div_event.ticker|default:"N/A" }} ({{div_event.instrument_name|default:'' }})</td>
                            <td class="numeric">{{ div_event.amount|floatformat:2 }}</td>
                            <td class="numeric">{{ div_event.tax_amount|floatformat:2 }}</td>
                            <td>{{ div_event.currency|default:"N/A" }}</td>
                            <td class="numeric">{{ div_event.cbr_rate_str|default:"-" }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {# –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–º–∏—Å—Å–∏–π —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å –¥–∏–≤–∏–¥–µ–Ω–¥–∞–º–∏ #}
        {% if dividend_commissions %}
        <div class="content-block">
            <h3>–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–º–∏—Å—Å–∏–π —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å –¥–∏–≤–∏–¥–µ–Ω–¥–∞–º–∏</h3>
            <p><strong>–û–±—â–∞—è —Å—É–º–º–∞: {{ total_dividend_commissions_rub|default:0|floatformat:2 }} RUB</strong></p>
            <table border="1" style="width:100%; border-collapse: collapse; margin-top: 10px;">
                <thead>
                    <tr>
                        <th>–¢–∏–∫–µ—Ä</th>
                        <th>–°—É–º–º—ã –≤ –≤–∞–ª—é—Ç–∞—Ö</th>
                        <th class="numeric">–°—É–º–º–∞ (RUB)</th>
                        <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                        <th>–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è</th>
                    </tr>
                </thead>
                <tbody>
                    {% for category_name, category_data in dividend_commissions.items %}
                        <tr>
                            <td>{{ category_name }}</td>
                            <td>
                                {% for currency_code, total_amount in category_data.amount_by_currency.items %}
                                    {{ total_amount|floatformat:2 }} {{ currency_code }}<br>
                                {% empty %}
                                    N/A
                                {% endfor %}
                            </td>
                            <td class="numeric" style="font-weight: bold;">{{ category_data.amount_rub|floatformat:2 }}</td>
                            <td>
                                {% if category_data.details %}
                                    <ul style="margin: 0; padding-left: 15px; font-size: 0.9em;">
                                        {% for detail in category_data.details %}
                                            <li>
                                                {{ detail.date }}:
                                                {% if detail.comment %}
                                                    {{ detail.comment|truncatechars:70 }}
                                                {% else %}
                                                    -
                                                {% endif %}
                                            </li>
                                        {% endfor %}
                                    </ul>
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                {% if category_data.details %}
                                    <ul style="margin: 0; padding-left: 15px; font-size: 0.9em;">
                                        {% for detail in category_data.details %}
                                            <li>{{ detail.amount|floatformat:2 }} {{ detail.currency }} ({{ detail.amount_rub|floatformat:2 }} RUB)</li>
                                        {% endfor %}
                                    </ul>
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
    {% elif processing_has_run_for_current_display and not parsing_error_occurred and not instrument_history_1530 and not instrument_history_1532 %}
         <div class="no-data-message">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è. –í–æ–∑–º–æ–∂–Ω–æ, –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ —Å –ø—Ä–æ–¥–∞–∂–∞–º–∏ –∏–ª–∏ –¥–∏–≤–∏–¥–µ–Ω–¥–æ–≤ –≤ —Ü–µ–ª–µ–≤–æ–º –≥–æ–¥—É ({{ target_report_year_for_title|default:"—É–∫–∞–∑–∞–Ω–Ω—ã–π" }}).</div>
    {% endif %}

    {# START: Block for Additional Commissions and Other Expenses/Income #}
    {% if processing_has_run_for_current_display %}
        <div class="content-block">
            <h2>–ü—Ä–æ—á–∏–µ —Ä–∞—Å—Ö–æ–¥—ã –∏ –¥–æ—Ö–æ–¥—ã –∑–∞ {{ target_report_year_for_title|default:"—É–∫–∞–∑–∞–Ω–Ω—ã–π" }} –≥–æ–¥</h2>
            {# –ö–æ–º–∏—Å—Å–∏–∏ –ø–æ –¥–∏–≤–∏–¥–µ–Ω–¥–∞–º —Ç–µ–ø–µ—Ä—å –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –±–ª–æ–∫–µ –ø–æ—Å–ª–µ —Ç–∞–±–ª–∏—Ü—ã –¥–∏–≤–∏–¥–µ–Ω–¥–æ–≤ #}
            <p><strong>–û–±—â–∞—è —Å—É–º–º–∞: {{ total_other_commissions_rub|default:0|floatformat:2 }} RUB</strong></p>
            <p style="color: #666; font-size: 0.9em;">–û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è = —Ä–∞—Å—Ö–æ–¥—ã (–∫–æ–º–∏—Å—Å–∏–∏, –ø—Ä–æ—Ü–µ–Ω—Ç—ã –∑–∞ –º–∞—Ä–∂—É). –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ = –¥–æ—Ö–æ–¥—ã (–∫—Ä–µ–¥–∏—Ç–Ω—ã–µ –ø—Ä–æ—Ü–µ–Ω—Ç—ã).</p>

            {% if other_commissions %}
                <table border="1" style="width:100%; border-collapse: collapse; margin-top: 10px;">
                    <thead>
                        <tr>
                            <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                            <th>–°—É–º–º—ã –≤ –≤–∞–ª—é—Ç–∞—Ö</th>
                            <th class="numeric">–°—É–º–º–∞ (RUB)</th>
                            <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                            <th>–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for category, data in other_commissions.items %}
                        <tr>
                            <td>{{ category }}</td>
                            <td>
                                {% for currency_code, amount_val in data.currencies.items %}
                                    {{ amount_val|floatformat:2 }} {{ currency_code }}<br>
                                {% empty %}
                                    –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö
                                {% endfor %}
                            </td>
                            <td class="numeric" style="font-weight: bold;">{{ data.total_rub|floatformat:2 }}</td>
                            <td>
                                <ul style="margin: 0; padding-left: 15px; font-size: 0.9em;">
                                {% for event in data.raw_events %}
                                    <li>
                                        {{ event.date|date:"Y-m-d" }}:
                                        {% if event.description %}
                                            {{ event.description }}
                                        {% elif event.source %}
                                            {{ event.source }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </li>
                                {% endfor %}
                                </ul>
                            </td>
                            <td>
                                <ul style="margin: 0; padding-left: 15px; font-size: 0.9em;">
                                {% for event in data.raw_events %}
                                    <li>{{event.amount|floatformat:2}} {{event.currency}} ({{event.amount_rub|floatformat:2}} RUB)</li>
                                {% endfor %}
                                </ul>
                            </td>

                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="5" style="text-align: center;">–ü—Ä–æ—á–∏–µ —Ä–∞—Å—Ö–æ–¥—ã –∏ –¥–æ—Ö–æ–¥—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p>–ü—Ä–æ—á–∏–µ —Ä–∞—Å—Ö–æ–¥—ã –∏ –¥–æ—Ö–æ–¥—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</p>
            {% endif %}
        </div>
    {% elif processing_has_run_for_current_display and not instrument_history_1530 and not instrument_history_1532 and not dividend_history %}
        <div class="content-block">
             <h2>–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ—á–∏—Ö –±—Ä–æ–∫–µ—Ä—Å–∫–∏—Ö –∫–æ–º–∏—Å—Å–∏–π –∑–∞ {{ target_report_year_for_title|default:"—É–∫–∞–∑–∞–Ω–Ω—ã–π" }} –≥–æ–¥</h2>
             <p class="no-data-message">–î–∞–Ω–Ω—ã–µ –ø–æ –∫–æ–º–∏—Å—Å–∏—è–º –Ω–µ –±—ã–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã –∏–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω—ã –≤ —à–∞–±–ª–æ–Ω.</p>
        </div>
    {% endif %}
    {# END: Block for Additional Commissions #}

    {% if parsing_error_occurred and processing_has_run_for_current_display %}
        <p style="margin-top:20px; color: #721c24; font-weight:bold; background-color: #f8d7da; border:1px solid #f5c6cb; padding:10px; border-radius:4px;"><b>–í–Ω–∏–º–∞–Ω–∏–µ:</b> –í–æ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–æ–≤ –ø—Ä–æ–∏–∑–æ—à–ª–∏ –æ—à–∏–±–∫–∏. –û—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ–ø–æ–ª–Ω—ã–º–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤—ã—à–µ.</p>
    {% endif %}

    {% if processing_has_run_for_current_display and instrument_history_1530 or instrument_history_1532 or dividend_history %}
        <div class="content-block" style="margin-top: 30px;">
            <h3 style="margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px;">–°–∫–∞—á–∞—Ç—å PDF –æ—Ç—á–µ—Ç</h3>
            <div style="display: flex; gap: 20px; align-items: flex-start;">
                <div style="flex: 1;">
                    <label for="pdf_comment" style="font-weight: bold;">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</label>
                    <p style="color: #888; font-size: 0.85em; margin-top: 2px; margin-bottom: 10px;">–î–æ–±–∞–≤—å—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –æ—Ç—á–µ—Ç—É –¥–ª—è –ò–Ω—Å–ø–µ–∫—Ç–æ—Ä–∞ –§–ù–°</p>
                    <textarea id="pdf_comment" name="pdf_comment" rows="4" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-family: inherit; font-size: 1em; resize: vertical; box-sizing: border-box;" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."></textarea>
                </div>
                <div style="display: flex; align-items: center; padding-top: 30px;">
                    <a href="{% url 'download_pdf' %}?year={{ target_report_year_for_title }}"
                       id="download_pdf_btn"
                       style="display: inline-block; padding: 15px 30px; background-color: #007bff; color: white; text-decoration: none; border: none; border-radius: 4px; cursor: pointer; font-size: 1.1em; font-weight: bold; transition: background-color 0.3s ease; white-space: nowrap;"
                       onmouseover="this.style.backgroundColor='#0056b3'"
                       onmouseout="this.style.backgroundColor='#007bff'"
                       onclick="return addCommentToUrl(this)">
                        –°–∫–∞—á–∞—Ç—å PDF
                    </a>
                </div>
            </div>
        </div>
    {% endif %}

    <script>
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–æ–≤ —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π —Ñ–æ—Ä–º–∞—Ç–∞
        document.getElementById('report_file_input').addEventListener('change', function(event) {
            const fileList = event.target.files;
            const selectedFilesDiv = document.getElementById('selected_files');
            const brokerSelect = document.getElementById('broker_type_select');
            const expectedExt = brokerSelect.value === 'ib' ? '.csv' : '.xml';
            const expectedExtUpper = expectedExt.toUpperCase();

            selectedFilesDiv.innerHTML = '';

            if (fileList.length > 0) {
                const invalidFiles = [];
                const validFiles = [];

                for (let i = 0; i < fileList.length; i++) {
                    const fileName = fileList[i].name;
                    const ext = fileName.substring(fileName.lastIndexOf('.')).toLowerCase();
                    if (ext === expectedExt) {
                        validFiles.push(fileName);
                    } else {
                        invalidFiles.push(fileName);
                    }
                }

                if (invalidFiles.length > 0) {
                    const errorDiv = document.createElement('div');
                    errorDiv.style.cssText = 'background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; padding: 10px; border-radius: 4px; margin-bottom: 10px;';
                    errorDiv.innerHTML = '<strong>–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞!</strong><br>–î–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –±—Ä–æ–∫–µ—Ä–∞ —Ç—Ä–µ–±—É–µ—Ç—Å—è —Ñ–æ—Ä–º–∞—Ç <strong>' + expectedExtUpper + '</strong>.<br>–ù–µ–ø–æ–¥—Ö–æ–¥—è—â–∏–µ —Ñ–∞–π–ª—ã: ' + invalidFiles.join(', ');
                    selectedFilesDiv.appendChild(errorDiv);

                    // –û—á–∏—â–∞–µ–º input –µ—Å–ª–∏ –µ—Å—Ç—å –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ —Ñ–∞–π–ª—ã
                    event.target.value = '';
                    return;
                }

                if (validFiles.length > 0) {
                    const fileListTitle = document.createElement('h4');
                    fileListTitle.style.marginTop = '0px'; fileListTitle.style.marginBottom = '5px';
                    fileListTitle.textContent = '–í—ã–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:';
                    selectedFilesDiv.appendChild(fileListTitle);

                    const fileListElement = document.createElement('ul');
                    fileListElement.style.marginTop = '0px';
                    for (let i = 0; i < validFiles.length; i++) {
                        const listItem = document.createElement('li');
                        listItem.textContent = validFiles[i];
                        fileListElement.appendChild(listItem);
                    }
                    selectedFilesDiv.appendChild(fileListElement);
                }
            }
        });

        // –§—É–Ω–∫—Ü–∏—è –≤—ã–±–æ—Ä–∞ –≥–æ–¥–∞
        function selectYear(year, btn) {
            // –£–±–∏—Ä–∞–µ–º selected —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
            document.querySelectorAll('.year-btn').forEach(b => {
                b.classList.remove('selected');
            });

            // –î–æ–±–∞–≤–ª—è–µ–º selected –Ω–∞ –Ω–∞–∂–∞—Ç—É—é –∫–Ω–æ–ø–∫—É
            btn.classList.add('selected');

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≤ —Å–∫—Ä—ã—Ç—ã–π input
            document.getElementById('year_input_process').value = year;

            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É —Ä–∞—Å—á—ë—Ç–∞
            updateProcessButton();
        }

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–∫–∏ —Ä–∞—Å—á—ë—Ç–∞
        function updateProcessButton() {
            const yearInput = document.getElementById('year_input_process');
            const processBtn = document.getElementById('process_btn');
            const hasYear = yearInput && yearInput.value;
            const hasReports = {{ has_uploaded_reports|yesno:"true,false" }};

            if (processBtn) {
                processBtn.disabled = !(hasYear && hasReports);
            }
        }

        // –í—ã–∑—ã–≤–∞–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        document.addEventListener('DOMContentLoaded', updateProcessButton);

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–æ–ø—É—Å—Ç–∏–º—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ —Ñ–∞–π–ª–æ–≤
        function updateFileAccept() {
            const brokerSelect = document.getElementById('broker_type_select');
            const fileInput = document.getElementById('report_file_input');
            const formatHint = document.getElementById('file_format_hint');
            const selectedFilesDiv = document.getElementById('selected_files');

            if (brokerSelect.value === 'ib') {
                fileInput.accept = '.csv';
                formatHint.textContent = '–§–æ—Ä–º–∞—Ç: .csv';
            } else {
                fileInput.accept = '.xml';
                formatHint.textContent = '–§–æ—Ä–º–∞—Ç: .xml';
            }
            // –û—á–∏—â–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –ø—Ä–∏ —Å–º–µ–Ω–µ –±—Ä–æ–∫–µ—Ä–∞
            fileInput.value = '';
            selectedFilesDiv.innerHTML = '';
        }

        // –ü—Ä–∏ —Å–º–µ–Ω–µ –±—Ä–æ–∫–µ—Ä–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –≥–æ–¥–æ–≤
        document.getElementById('broker_type_select').addEventListener('change', function() {
            const selectedBroker = this.value;
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—ã–±–æ—Ä–∞ –±—Ä–æ–∫–µ—Ä–∞
            window.location.href = '?set_broker=' + selectedBroker;
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            updateFileAccept();
        });

        // –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –∫ URL –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ PDF
        function addCommentToUrl(link) {
            const comment = document.getElementById('pdf_comment');
            if (comment && comment.value.trim()) {
                const baseUrl = link.href.split('?')[0];
                const params = new URLSearchParams(link.href.split('?')[1] || '');
                params.set('comment', comment.value.trim());
                link.href = baseUrl + '?' + params.toString();
            }
            return true;
        }
    </script>
</body>
</html>
