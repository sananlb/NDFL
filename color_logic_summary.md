# Цветная маркировка - Краткая сводка

## Главное правило

**Каждая пара (покупка → продажа) = уникальный цвет**

---

## Ключевые факты

### ✅ Что показывается:
- Покупка может иметь **несколько** цветов (если используется в нескольких продажах)
- Продажа может иметь **несколько** цветов (если использует несколько покупок)
- Квадратики слева, количество справа

### ❌ Что НЕ показывается:
- Серые строки (не релевантные для целевого года)
- Пары, где хотя бы одна сделка не релевантна
- Начальные остатки (по дизайну)

---

## "Релевантна для целевого года" ≠ "Совершена в целевом году"

| Тип сделки | Условие релевантности |
|------------|----------------------|
| **Продажа** | Совершена **В** целевом году |
| **Покупка** | **ИСПОЛЬЗУЕТСЯ** в продажах целевого года (даже если покупка из прошлого!) |
| **Начальный остаток** | Используется в продажах целевого года |

**Пример:**
```
Покупка 2023-11-28 (серая) → используется в продаже 2025-08-14 → РЕЛЕВАНТНА для 2025!
                                                                 → Получает цвет ✓
```

---

## Алгоритм (упрощённо)

```
1. Установить is_relevant_for_target_year для всех сделок
   ├─ Продажи целевого года → релевантны
   └─ Покупки из used_buy_ids_for_target_year → релевантны

2. Создать словарь trade_id_to_relevant (быстрый поиск)
   └─ Включая original_trade_ids для агрегированных

3. Для каждой релевантной продажи:
   └─ Для каждого buy_id в used_buy_ids:
      └─ Если buy тоже релевантна:
         └─ pair_to_color[(buy_id, sell_id)] = новый_цвет

4. Для каждой покупки:
   └─ Найти все пары (этот_buy_id, *)
   └─ Собрать цвета

5. Для каждой продажи:
   └─ Найти все пары (*, этот_sell_id)
   └─ Собрать цвета
```

---

## Важные детали

### Шорты
ID будущей покупки добавляется в `used_buy_ids` продажи:
```python
# FFG_ndfl.py:361-364
original_short_trade_ref['used_buy_ids'].append(op.get('trade_id'))
```

Поэтому продажа-шорт получает два цвета:
- Для прошлой покупки (частичное покрытие)
- Для будущей покупки (покрытие шорта)

### Агрегация
```python
# Агрегированная покупка
original_trade_ids = ['A', 'B', 'C']
trade_id = 'AGG_123'

# Продажа использует оригинальные ID
used_buy_ids = ['A', 'D']

# Маппинг работает:
trade_id_to_relevant['A'] = True  # Из original_trade_ids
pair_to_color[('A', 'SELL_789')] = color
trade_id_to_colors['AGG_123'] = [color]  # Агрегированная получает цвет
```

---

## Ограничения

| Проблема | Последствия |
|----------|-------------|
| `used_buy_ids` содержит ID начального остатка | Цвет не создаётся |
| `used_buy_ids` содержит "потерянный" ID | Цвет не создаётся |
| Начальный остаток используется в продаже | Квадратик не показывается |

**Почему:**
Словарь `trade_id_to_relevant` строится только для `display_type == 'trade'`

**Если нужно исправить:**
```python
# Было:
if event_wrapper.get('display_type') == 'trade':

# Станет:
if event_wrapper.get('display_type') in ['trade', 'initial_holding']:
```

---

## Порядок выполнения (КРИТИЧНО!)

```
❌ НЕПРАВИЛЬНО (было раньше):
   Агрегация → Цветовая маркировка → Установка is_relevant → Return

✅ ПРАВИЛЬНО (сейчас):
   Агрегация → Установка is_relevant → Цветовая маркировка → Return
                ↑ Сначала это!        ↑ Потом это!
```

Если порядок нарушен, все проверки `is_relevant_for_target_year` возвращают `False` → цвета не создаются.

---

## Код-локации

| Что | Где |
|-----|-----|
| Установка `is_relevant` | [FFG_ndfl.py:1438-1517](c:\Users\_batman_\Desktop\NDFL\reports_to_ndfl\FFG_ndfl.py#L1438-L1517) |
| Цветовая маркировка | [FFG_ndfl.py:1519-1628](c:\Users\_batman_\Desktop\NDFL\reports_to_ndfl\FFG_ndfl.py#L1519-L1628) |
| Добавление ID при покрытии шорта | [FFG_ndfl.py:361-364](c:\Users\_batman_\Desktop\NDFL\reports_to_ndfl\FFG_ndfl.py#L361-L364) |
| Шаблон отображения | [upload.html:235-244](c:\Users\_batman_\Desktop\NDFL\reports_to_ndfl\templates\reports_to_ndfl\upload.html#L235-L244) |
| CSS стили | [upload.html:75-100](c:\Users\_batman_\Desktop\NDFL\reports_to_ndfl\templates\reports_to_ndfl\upload.html#L75-L100) |

---

## Полная документация

Смотри [color_logic_explanation.md](c:\Users\_batman_\Desktop\NDFL\color_logic_explanation.md) для детального объяснения с примерами.
