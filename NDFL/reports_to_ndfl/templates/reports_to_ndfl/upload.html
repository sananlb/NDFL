<!DOCTYPE html>
<html>
<head>
    <title>Загрузка XML отчетов</title>
    <style>
        body { font-family: sans-serif; margin: 20px; line-height: 1.6; background-color: #f4f7f6; }
        h1, h2, h3, h4, h5 { color: #333; }
        .container { display: flex; flex-wrap: wrap; gap: 20px; }
        .main-content { flex: 2; min-width: 200px;}
        .sidebar { flex: 3; min-width: 300px; }

        .messages { list-style-type: none; padding: 0; margin-bottom: 20px; }
        .messages li { margin-bottom: 10px; padding: 10px 15px; border-radius: 4px; border: 1px solid transparent; }
        .messages li.success { background-color: #d4edda; color: #155724; border-color: #c3e6cb; }
        .messages li.error { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb; }
        .messages li.warning { background-color: #fff3cd; color: #856404; border-color: #ffeeba; }
        .messages li.info { background-color: #d1ecf1; color: #0c5460; border-color: #bee5eb; }

        .form-section {
            border: 1px solid #ddd;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 5px;
            background-color: #ffffff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .form-section h3 { margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px; }

        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555}
        input[type="number"], input[type="file"] {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: calc(100% - 22px);
            box-sizing: border-box;
            margin-bottom: 10px;
        }
        button[type="submit"] {
            padding: 12px 25px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease;
        }
        button[type="submit"]:hover { background-color: #0056b3; }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9em; table-layout: auto; background-color: #fff; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; word-wrap: break-word; }
        th { background-color: #e9ecef; font-weight: bold; white-space: nowrap; color: #495057; }
        td.numeric { text-align: right; }

        .content-block {
            margin-bottom: 30px;
            border: 1px solid #ccc;
            padding: 20px;
            border-radius: 5px;
            background-color: #ffffff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            overflow-x: auto;
        }
        .content-block h3 {
             border-bottom: 1px solid #eee; padding-bottom: 10px; margin-top:0;
        }
        .content-block h2 {
            margin-top:0;
        }
        .conversion-row td { background-color: #e6f7ff !important; font-style: italic;}
        .aggregated-trade-row td {}


        #selected_files ul { list-style-type: disc; margin-left: 20px; padding-left: 0; margin-top: 5px; }
        #selected_files h4 { margin-bottom: 5px; }

        .user-info { text-align: right; margin-bottom: 20px; padding-bottom:10px; border-bottom: 1px solid #eee; }
        .user-info a { color: #007bff; text-decoration: none; }
        .user-info a:hover { text-decoration: underline; }

        .previously-uploaded-section {
            padding:20px;
            border: 1px solid #e0e0e0;
            background-color:#f0f0f0;
            border-radius:5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .previously-uploaded-section h4 { margin-top: 0; border-bottom: 1px solid #ddd; padding-bottom: 10px;}
        .previously-uploaded-section ul { list-style-type: none; padding-left: 0; }
        .previously-uploaded-section li {
            background-color: #fff;
            border: 1px solid #eee;
            padding: 10px 15px;
            margin-bottom: 8px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.95em;
        }
        .previously-uploaded-section li .date { font-size: 0.85em; color: #777; margin-left: 10px; white-space: nowrap;}

        .no-data-message { margin-top: 20px; padding: 15px; background-color: #f8f9fa; border: 1px solid #ced4da; border-radius: 4px; text-align: center; color: #495057;}

        @media (max-width: 768px) {
            .container { flex-direction: column; }
            .main-content, .sidebar { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="user-info">
        {% if user.is_authenticated %}
            Пользователь: <strong>{{ user.username }}</strong> | <a href="{% url 'logout' %}">Выйти</a>
        {% else %}
            <a href="{% url 'login' %}">Войти</a>
        {% endif %}
    </div>

    <h1>Загрузка и анализ XML отчетов брокера</h1>

    {% if messages %}
        <ul class="messages">
            {% for message in messages %}
                <li class="{{ message.tags }}">{{ message }}</li>
            {% endfor %}
        </ul>
    {% endif %}

    <div class="container">
        <div class="main-content">
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="form-section">
                    <h3>1. Загрузка отчетов брокера</h3>
                    <div>
                        <label for="xml_file_input">Файл(ы) XML для загрузки:</label>
                        <input type="file" name="xml_file" id="xml_file_input" multiple>
                    </div>
                    <div id="selected_files" style="margin-top:10px; margin-bottom:15px;"></div>
                    <button type="submit" name="action" value="upload_reports">Загрузить выбранные отчеты</button>
                </div>
                <div class="form-section">
                    <h3>2. Анализ и расчет сделок и дивидендов</h3>
                    <div>
                        <label for="year_input_process">Целевой год для анализа:</label>
                        <input type="number" name="year_for_process" id="year_input_process" required placeholder="YYYY" value="{{ target_report_year_for_title|default_if_none:'' }}">
                    </div>
                    <button type="submit" name="action" value="process_trades">Рассчитать данные за указанный год</button>
                </div>
            </form>
        </div>
        <div class="sidebar">
            {% if user.is_authenticated %}
            <div class="previously-uploaded-section">
                <h4>Ранее загруженные вами отчеты:</h4>
                {% if previously_uploaded_files %}
                    <ul>
                        {% for file_entry in previously_uploaded_files %}
                        <li>
                            <span>{{ file_entry.original_filename }} (Отчет за {{ file_entry.year }} год)</span>
                            <span class="date">Загружен: {{ file_entry.uploaded_at|date:"d.m.Y H:i" }}</span>
                        </li>
                        {% endfor %}
                    </ul>
                {% else %} <p>Вы еще не загружали отчеты.</p> {% endif %}
            </div>
            {% endif %}
        </div>
    </div>

    {% if instrument_event_history %}
        <div class="content-block">
            <h2>История операций по инструментам с продажами в {{ target_report_year_for_title|default:"указанный" }} году (код дохода 1530):</h2>
            <h3>Общий финансовый результат по сделкам продажи: {{ total_sales_profit_rub|floatformat:2 }} RUB</h3>
            <br>
            {% for grouping_isin, event_list in instrument_event_history.items %}
                <div class="instrument-specific-block" style="margin-bottom: 20px;">
                    {% with first_event_wrapper=event_list.0 %}{% with first_event=first_event_wrapper.event_details %}
                        {% if first_event_wrapper.display_type == 'conversion_info' %}
                            <h3>История для: {{ first_event.new_ticker|default:first_event.new_isin }} (результат конвертации из {{ first_event.old_ticker|default:first_event.old_isin }})</h3>
                        {% elif first_event_wrapper.display_type == 'trade' or first_event_wrapper.display_type == 'initial_holding' %}
                            <h3>Инструмент: {{ first_event.instr_nm|default_if_none:"[Наименование не указано]" }} (isin: {{ grouping_isin }})</h3>
                        {% else %}<h3>История для ISIN: {{ grouping_isin }}</h3>{% endif %}
                    {% endwith %}{% endwith %}
                    <table>
                        <thead><tr><th>Дата</th><th>ID</th><th>Операция</th><th>Инструмент</th><th>Цена</th><th>Кол-во</th><th>Сумма</th><th>Ком.</th><th>FIFO Затраты, RUB</th></tr></thead>
                        <tbody>
                            {% for event_wrapper in event_list %}{% with event=event_wrapper.event_details %}
                                {% if event_wrapper.display_type == 'trade' %}
                                    <tr {% if event.is_aggregated %}class="aggregated-trade-row"{% endif %}>
                                        <td>{{ event.date|default:"-" }} {% if event.is_aggregated %}<small>(Aggregated)</small>{% endif %}</td>
                                        <td> {{ event.trade_id|default:"-" }}</td>
                                        <td>{% if event.operation|lower == 'buy' %}Покупка{% elif event.operation|lower == 'sell' %}Продажа{% else %}{{ event.operation|default:"-" }}{% endif %}</td>
                                        <td>{{ event.instr_nm|default:event.isin }}</td>
                                        <td class="numeric">{{ event.p|default:"-" }}</small></td>
                                        <td class="numeric">{{ event.q|default:"-" }}</td>
                                        <td class="numeric"><strong>{{ event.summ|default:"-" }}</strong><small> {{ event.curr_c|default:"" }}</small></td>
                                        <td class="numeric">{{ event.commission|default:"-" }}<small> {{ event.curr_c|default:"" }}</small></td>
                                        <td class="numeric"><strong>{{ event.fifo_cost_rub_str|default:"-" }}</strong></td>
                                    </tr>
                                {% elif event_wrapper.display_type == 'conversion_info' %}
                                    <tr class="conversion-row">
                                        <td>{{ event_wrapper.datetime_obj|date:"Y-m-d" }}</td><td>Конвертация ID: {{ event.corp_action_id|default:"N/A" }}</td>
                                        <td colspan="2"><strong>Конвертация акций</strong><br>Списано: {{ event.old_quantity_removed|default:'?' }} шт. {{ event.old_ticker|default:event.old_isin }} ({{event.old_isin}})<br>Получено: {{ event.new_quantity_received|default:'?' }} шт. {{ event.new_ticker|default:event.new_isin }} ({{event.new_isin}})</td>
                                        <td colspan="3"><i>{{ event.ratio_comment|truncatechars:120 }}</i></td><td>-</td><td>-</td>
                                    </tr>
                                {% elif event_wrapper.display_type == 'initial_holding' %}
                                    <tr>
                                        <td>{{ event_wrapper.datetime_obj|date:"Y-m-d H:i:s" }}</td><td>Начальный остаток</td><td>Зачисление</td>
                                        <td>{{ event.instr_nm|default:event.isin }} ({{event.isin}})</td>
                                        <td class="numeric">{{ event.p|default:"-" }} <small>{{ event.curr_c|default:"" }}</small></td>
                                        <td class="numeric">{{ event.q|default:"-" }}</td>
                                        <td class="numeric">Общ. стоим. {{ event.total_cost_rub_str|default:"-" }} RUB</td>
                                        <td>-</td><td>-</td>
                                    </tr>
                                {% endif %}
                            {% endwith %}{% endfor %}
                        </tbody>
                    </table>
                </div>
            {% empty %}
                {% if processing_has_run_for_current_display and not parsing_error_occurred and not dividend_history %}
                     <div class="no-data-message">История операций по инструментам с продажами в целевом году ({{ target_report_year_for_title|default:"указанный" }}) не найдена или отсутствует.</div>
                {% endif %}
            {% endfor %}
        </div>
    {% endif %}

    {% if dividend_history %}
        <div class="content-block">
            <h2>История дивидендов за {{ target_report_year_for_title|default:"указанный" }} год (код дохода 1010):
                {% if total_dividends_rub > 0 %}
                 <p><small>Общая сумма дивидендов до налогов: {{ total_dividends_rub|floatformat:2 }} RUB</p></small> {% endif %}
                 <br>
            </h2>
            <table>
                <thead>
                    <tr>
                        <th>Дата выплаты</th>
                        <th>Инструмент</th>
                        <th class="numeric">Сумма дивиденда</th>
                        <th class="numeric">Удержанный налог</th>
                        <th>Валюта</th>
                        <th class="numeric">Курс ЦБ на дату</th>
                    </tr>
                </thead>
                <tbody>
                    {% for div_event in dividend_history %}
                        <tr>
                            <td>{{ div_event.date|date:"Y-m-d" }}</td>
                            <td>{{ div_event.ticker|default:"N/A" }} ({{div_event.instrument_name|default:'' }})</td>
                            <td class="numeric">{{ div_event.amount|floatformat:2 }}</td>
                            <td class="numeric">{{ div_event.tax_amount|floatformat:2 }}</td>
                            <td>{{ div_event.currency|default:"N/A" }}</td>
                            <td class="numeric">{{ div_event.cbr_rate_str|default:"-" }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% elif processing_has_run_for_current_display and not parsing_error_occurred and not instrument_event_history %}
         <div class="no-data-message">Нет данных для отображения. Возможно, не найдено инструментов с продажами или дивидендов в целевом году ({{ target_report_year_for_title|default:"указанный" }}).</div>
    {% endif %}

    {# START: Block for Additional Commissions #}
    {% if processing_has_run_for_current_display %}
        <div class="content-block">
            <h2>Детализация прочих брокерских комиссий за {{ target_report_year_for_title|default:"указанный" }} год</h2>

            {# --- ОТЛАДОЧНЫЙ ВЫВОД (ОСТАВЬТЕ ЭТО!) --- #}
            <div style="background-color: #f0f0f0; border: 1px dashed #ccc; padding: 10px; margin: 10px 0; font-size: 0.8em;">
                <p><strong>DEBUGGING OUTPUT (из upload.html):</strong></p>
                <p>dividend_commissions (структура): <code>{ "Категория (Тикер)": {'amount_by_currency': {'USD': Сумма, ...}, 'amount_rub': СуммаRUB, 'details': [...]}, ... }</code></p>
                <p style="word-break: break-all;">dividend_commissions (данные): {{ dividend_commissions|default_if_none:"{}"|safe }}</p>
                <hr>
                <p>other_commissions (структура): <code>{ "Категория": {'currencies': {'USD': Сумма, ...}, 'total_rub': СуммаRUB, 'raw_events': [...]}, ... }</code></p>
                <p style="word-break: break-all;">other_commissions (данные): {{ other_commissions|default_if_none:"{}"|safe }}</p>
                <hr>
                <p>total_other_commissions_rub: {{ total_other_commissions_rub|default_if_none:"0.00"|safe }}</p>
            </div>
            {# --- КОНЕЦ ОТЛАДОЧНОГО ВЫВОДА --- #}

            {# ----- Комиссии, связанные с дивидендами (ИСПРАВЛЕНО)----- #}
            <h4>Комиссии, связанные с дивидендами:</h4>
            {% if dividend_commissions %}
                <table border="1" style="width:100%; border-collapse: collapse; margin-top: 10px;">
                    <thead>
                        <tr>
                            <th>Категория (Тикер)</th>
                            <th>Суммы в валютах</th>
                            <th class="numeric">Общая сумма (RUB)</th>
                            <th>Детализация</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for category_name, category_data in dividend_commissions.items %}
                            <tr>
                                <td>{{ category_name }}</td>
                                <td>
                                    {% for currency_code, total_amount in category_data.amount_by_currency.items %}
                                        {{ total_amount|floatformat:2 }} {{ currency_code }}<br>
                                    {% empty %}
                                        N/A
                                    {% endfor %}
                                </td>
                                <td class="numeric">{{ category_data.amount_rub|floatformat:2 }}</td>
                                <td>
                                    {% if category_data.details %}
                                        <ul style="margin: 0; padding-left: 15px; font-size: 0.9em;">
                                            {% for detail in category_data.details %}
                                                <li>
                                                    {{ detail.date }}: {{ detail.amount|floatformat:2 }} {{ detail.currency }}
                                                    (<strong>{{ detail.amount_rub|floatformat:2 }} RUB</strong>)
                                                    {% if detail.comment %} - <i>{{ detail.comment|truncatechars:70 }}</i>{% endif %}
                                                    <br><small>(Файл: {{ detail.source_file }}; ID транз.: {{ detail.transaction_id }})</small>
                                                </li>
                                            {% endfor %}
                                        </ul>
                                    {% else %}
                                        Нет деталей
                                    {% endif %}
                                </td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="4" style="text-align: center;">Комиссии, связанные с дивидендами, не найдены или равны нулю.</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                 <p>Комиссии, связанные с дивидендами, не найдены (данные отсутствуют).</p>
            {% endif %}

            {# ----- Прочие комиссии ----- #}
            <h4 style="margin-top: 20px;">Прочие комиссии (не учтенные в сделках продажи и не связанные с дивидендами):</h4>
            {% if total_other_commissions_rub > 0 %}
                 <p><small>Общая сумма прочих комиссий: {{ total_other_commissions_rub|floatformat:2 }} RUB</p></small>
            {% endif %}

            {% if other_commissions %}
                <table border="1" style="width:100%; border-collapse: collapse; margin-top: 10px;">
                    <thead>
                        <tr>
                            <th>Категория</th>
                            <th>Суммы в валютах</th>
                            <th class="numeric">Общая сумма (RUB)</th>
                            {# Если нужна детализация для other_commissions, можно добавить столбец #}
                        </tr>
                    </thead>
                    <tbody>
                    {% for category, data in other_commissions.items %}
                        <tr>
                            <td>{{ category }}</td>
                            <td>
                                {% for currency_code, amount_val in data.currencies.items %}
                                    {% if amount_val > 0 %}
                                        {{ amount_val|floatformat:2 }} {{ currency_code }}<br>
                                        {# Если хотите показывать эквивалент в RUB для каждой валюты здесь,
                                           потребуется изменить структуру data.currencies или data.raw_events
                                           чтобы легко сопоставить суммы в валюте с их RUB эквивалентами из raw_events.
                                           Либо суммировать event.amount_rub из raw_events для данной currency_code.
                                           Текущий вывод RUB для каждой валюты в data.raw_events был бы слишком громоздким тут.
                                           Проще показывать общую сумму по категории в RUB, что уже делается.
                                        #}
                                    {% endif %}
                                {% empty %}
                                    Нет данных
                                {% endfor %}
                            </td>
                            <td class="numeric" style="font-weight: bold;">{{ data.total_rub|floatformat:2 }}</td>
                            {# Пример детализации, если есть data.raw_events и нужно:
                            <td>
                                <ul style="margin: 0; padding-left: 15px; font-size: 0.9em;">
                                {% for event in data.raw_events %}
                                    <li>{{ event.date|date:"Y-m-d" }}: {{event.amount|floatformat:2}} {{event.currency}} ({{event.amount_rub|floatformat:2}} RUB) - {{event.source}}</li>
                                {% endfor %}
                                </ul>
                            </td>
                            #}
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="3" style="text-align: center;">Прочие нераспределенные комиссии не найдены.</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p>Прочие нераспределенные комиссии не найдены (данные отсутствуют).</p>
            {% endif %}
        </div>
    {% elif processing_has_run_for_current_display and not instrument_event_history and not dividend_history %}
        <div class="content-block">
             <h2>Детализация прочих брокерских комиссий за {{ target_report_year_for_title|default:"указанный" }} год</h2>
             <p class="no-data-message">Данные по комиссиям не были обработаны или переданы в шаблон.</p>
        </div>
    {% endif %}
    {# END: Block for Additional Commissions #}

    {% if parsing_error_occurred and processing_has_run_for_current_display %}
        <p style="margin-top:20px; color: #721c24; font-weight:bold; background-color: #f8d7da; border:1px solid #f5c6cb; padding:10px; border-radius:4px;"><b>Внимание:</b> Во время обработки файлов произошли ошибки. Отображаемые данные могут быть неполными. Пожалуйста, проверьте сообщения выше.</p>
    {% endif %}

    <script>
        document.getElementById('xml_file_input').addEventListener('change', function(event) {
            const fileList = event.target.files;
            const selectedFilesDiv = document.getElementById('selected_files');
            selectedFilesDiv.innerHTML = '';
            if (fileList.length > 0) {
                const fileListTitle = document.createElement('h4');
                fileListTitle.style.marginTop = '0px'; fileListTitle.style.marginBottom = '5px';
                fileListTitle.textContent = 'Выбранные файлы:'; selectedFilesDiv.appendChild(fileListTitle);
                const fileListElement = document.createElement('ul'); fileListElement.style.marginTop = '0px';
                for (let i = 0; i < fileList.length; i++) {
                    const listItem = document.createElement('li'); listItem.textContent = fileList[i].name;
                    fileListElement.appendChild(listItem);
                }
                selectedFilesDiv.appendChild(fileListElement);
            }
        });
        const yearInputHTML = document.getElementById('year_input_process');
        if (yearInputHTML) {
            const defaultYearValue = "{{ request.session.last_target_year|default_if_none:'' }}";
            if (yearInputHTML.value === '' && defaultYearValue !== '') { yearInputHTML.value = defaultYearValue; }
        }
    </script>
</body>
</html>