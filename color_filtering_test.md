# Тест фильтрации цветов по релевантности года

## Проблема #1: Цвета исчезли полностью
**Причина:** Цветовая маркировка выполнялась ДО установки `is_relevant_for_target_year`
**Решение:** Переместили блок цветовой маркировки (строки 1519-1628) ПОСЛЕ установки релевантности (строка 1517)

## Проблема #2: Актуальные сделки связаны с неактуальными
Когда актуальные сделки (2025) связаны с неактуальными сделками (2024), цветные квадратики
показывались и для тех пар, где одна из сделок не относится к целевому году.

## Пример: CCBN.KZ

### До исправления:
Покупки 2023 года (серые, неактуальные) → имели квадратики, связывающие с продажами 2025
Продажа 2025 года → имела квадратики, связывающие с покупками 2023/2024

### После исправления:
- **Создаём пары только если ОБЕ сделки релевантны для целевого года**
- Серые строки (не целевого года) → без квадратиков
- Актуальные строки → квадратики только для связей с другими актуальными строками

## Логика фильтрации:

### Шаг 0: Создаём словарь trade_id → is_relevant
- Для обычных сделок: берём is_relevant_for_target_year
- Для агрегированных: используем is_relevant агрегированной сделки для всех original_trade_ids

### Шаг 1: Создаём цветные пары с фильтрацией
```python
for sell in продажи:
    if NOT sell.is_relevant:
        continue  # Пропускаем неактуальные продажи

    for buy_id in sell.used_buy_ids:
        buy_is_relevant = trade_id_to_relevant.get(buy_id)

        if buy_is_relevant AND sell.is_relevant:
            # Создаём пару только если ОБЕ сделки актуальны
            pair_to_color[(buy_id, sell_id)] = new_color()
```

### Результат:
- Покупки 2023/2024 (неактуальные) → 0 квадратиков
- Покупка 2025-05-02 (актуальная) → квадратики только для связи с продажей 2025-08-14
- Продажа 2025-08-14 (актуальная) → квадратики только для покупки 2025-05-02
- Покупка 2025-11-17 (актуальная) → 0 квадратиков (пока не используется в продажах)

## Дополнительное исправление:

### Границы ячеек таблицы
- Убрали переопределение `padding` в `.quantity-cell`
- Оставили базовый `padding: 10px` из `td`
- Добавили `!important` для `display: flex` чтобы flexbox не ломал границы
